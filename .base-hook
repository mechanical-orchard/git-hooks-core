#!/usr/bin/env bash

set -eu

git_dir=$( git rev-parse --git-dir )
script_name=$(basename $0)
if [ -f "${git_dir}/hooks/${script_name}" ]; then
  "${git_dir}/hooks/${script_name}" $@
fi

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
EXCLUDELIST=${DIR}/excludelist

excluded() {
  file=$1
  path=${DIR}/excludelist.d/$file

  if [ -f "${path}" ]; then
    while read -r; do
      if [ $REPLY == $(pwd) ]; then
        return 0
      fi
    done < ${path}
  fi

  return 1
}

excludelist=""

is_excluded() {
  hookPath=$1

  while read -ra LINE; do
    excludeListEntry="${LINE[0]}"
    if [ "$hookPath" == "$excludeListEntry" ]; then
      excludelist="${LINE[1]}"
      return 0
    fi
  done < ${EXCLUDELIST}

  return 1
}

HOOKS_DIR="${DIR}/$( basename ${0} ).d"

for hook in $( ls $HOOKS_DIR ); do
  REL_HOOK="$( basename ${0} ).d"/$hook

  if is_excluded $REL_HOOK; then
    if excluded $excludelist; then
      continue
    fi
  fi

  $HOOKS_DIR/$hook $@
done
